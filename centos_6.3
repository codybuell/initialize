#!/bin/bash
#
# CentOS 6.3
#
# Configuration script for CentOS 6.3 to setup a web and mail server hosting
# multiple domains.  Built for Rackspace cloud servers but could easily be
# adapted for any CentOS 6.3 installation.  Built as fast, lightweight and
# secure as possible.
#
# Author(s): Cody Buell
#
# Revisions: 2012.10.20 Initial framework.
#
# Requisite: CentOS 6.3
#
# Resources: 
#
# Task List: - create script to generate virtualhost conf files in httpd/conf.d
#            - create script to manage email accounts
#            - configure this script to work with other distros
#            - prompts to determine what to configure (apache, mail, both...)
#            - yum removes? network manager? managers?

####################
# Helper Functions #
####################

checks () {
  FUN=$(basename $0)                          # get function name
  LOC=`echo $0 | sed "s/${FUN}//"`            # get current location
  DIE=false                                   # default no errors
  [ `whoami` != $1 ] && {                     # check for correct user
    echo "error: $FUN must be run as $1"      # wrong user error message
    DIE=true                                  # register errors
  }
  [ "$0" != $2/$(basename $0) ] && {          # check for correct path
    echo "error: $FUN must be run from $LOC"  # wrong path error message
    DIE=true                                  # register errors
  }
  if $DIE; then
    exit 1                                    # drop out of script
  fi
}

prompt () {
  eval DEFAULT=\$$2                   # references an external default variable
  read -p "$1 [$DEFAULT] " NEWVALUE   # read answer into a temporary variable
  eval $2=${NEWVALUE:-$DEFAULT}       # param expan if null or unset use default
}

installTemplate () {
  cp -a $2 $2.orig                              # creat backup of original file
  sed -n "/<${3}>/,/<\/${3}>/p" $1 > $2         # replace with template chunk
  sed -i "/<${3}>/d;/<\/${3}>/d" $2             # clear out the tags
}

##################
# Initial Checks #
##################

checks root .

#######################
# Establish Variables #
#######################

DIR=`pwd`
TEM="$DIR/templates/"
IP=`ifconfig | grep 'inet addr:' | grep -v '127.0.0.1' | cut -d: -f2 | awk 'NR==1 {print $1}'`
CONFIRMATION='no'

# setup a decent environment
export EDITOR='vi'

# establish defaults
USERNAME='admin'
GUID='615'
SSHPORT='ssh'
DOMAIN='example.com'
ADMIN='admin@example.com'
PASSWD=''

# prompts
while [ $CONFIRMATION == "no" ]; do
  clear
  prompt "What username would you like?" USERNAME
  prompt "What is $USERNAME's uid and gid?" GUID
  prompt "What port would you like to use for ssh?" SSHPORT
  prompt "What is this systems short name?" HOSTNAME
  prompt "What is this systems domain name?" DOMAIN
  prompt "What is the server admins email?" ADMIN
  stty -echo
  prompt "Define a password for mysql mail_admin." PASSWD
  stty echo
  echo ""
  echo "                     Your Username: $USERNAME"
  echo "              Your User & Group ID: $GUID"
  echo "                          SSH Port: $SSHPORT"
  echo "                   Host Short Name: $HOSTNAME"
  echo "                            Domain: $DOMAIN"
  echo "       Fully Qualified Domain Name: $HOSTNAME.$DOMAIN"
  echo "        Server Administrator Email: $ADMIN"
  if [ -z "$PASSWD" ]; then
    echo " MySQL mail_admin Account Password: UNSET"
  else
    echo " MySQL mail_admin Account Password: *****"
  fi
  echo ""
  echo "Is the above information correct?"
  select yn in "Yes" "No"; do
    case $yn in
      Yes ) echo ""
      echo "Are you sure you wish to proceed?"
            select final in "Yes" "No"; do
              case $final in
                Yes ) CONFIRMATION="yes"; echo ""; break;;
                No ) echo ""; exit 0; break;;
              esac
            done
            break;;
      No ) CONFIRMATION="no"; break;;
    esac
  done
done


##########
# Run It #
##########

# patch update and install needed packages
yum -y update
yum -y install man wget vim telnet crypto-utils mod_ssl tree bind-utils ntp httpd mysql-server php php-mysql postfix dovecot dovecot-mysql mailx sudo git ruby rubygems setroubleshoot

# enable other repos

# setup hostname
sed -i "s/\(^HOSTNAME=\).*/\1${HOSTNAME}/" /etc/sysconfig/network
hostname $HOSTNAME
echo -e "${IP}\t${HOSTNAME}.${DOMAIN} ${HOSTNAME}" >> /etc/hosts

# setup user accounts
useradd -u $GUID -d /home/$USERNAME/ -m -U -s /bin/bash $USERNAME
useradd -u 5000 -d /var/mail/vhosts/ -m -U -s /sbin/nologin vmail
groupmems -a $USERNAME -g wheel
echo "In the following screen, uncomment the line:"
echo "  # %wheel  ALL=(ALL) NOPASSWD: ALL"
echo "Press any key to begin."
read -n 1
visudo
echo "Set a password for $USERNAME."
passwd $USERNAME

# dotfiles
installTemplate ${TEM}bashrc ~/.bashrc DEFAULT
installTemplate ${TEM}bashrc /home/$USERNAME/.bashrc DEFAULT
# vim files !!

# configure ssh
echo "" >> /etc/ssh/sshd_config
echo "# Customizations" >> /etc/ssh/sshd_config
echo "AllowUsers $USERNAME" >> /etc/ssh/sshd_config
echo "Port $SSHPORT" >> /etc/ssh/sshd_config
echo "PermitRootLogin no" >> /etc/ssh/sshd_config

# configure iptables
chkconfig iptables on
installTemplate ${TEM}iptables /etc/sysconfig/iptables FULL
sed -i "s/--dport ssh/--dport ${SSHPORT}/g" /etc/sysconfig/iptables

# enable selinux
sed -i "s/\(SELINUX=\).*$/\1enforcing/" /etc/sysconfig/selinux
sed -i "s/\(SELINUXTYPE=\).*$/\1targeted/" /etc/sysconfig/selinux
[ $SSHPORT != 'ssh' ] && {
  semanage port -a -t ssh_port_t -p tcp $SSHPORT
}
touch /.autorelabel

# configure mysql
chkconfig mysqld on
service mysqld start
mysql_secure_installation
sed -i 's/\[mysqld\]/&\nbind-address=127.0.0.1/' /etc/my.cnf

# configure ntp
NTPSERVER=`cat /etc/ntp.conf | sed -n 's/^server //p' | head -1`
chkconfig ntpd on
ntpdate $NTPSERVER

# configure php
mv /etc/php.d/sqlite3.ini /etc/php.d/sqlite3.disable
mv /etc/php.d/pdo_sqlite.ini /etc/php.d/pdo_sqlite.disable
mv /etc/php.d/curl.ini /etc/php.d/curl.disable
mv /etc/php.ini /etc/php.ini.orig
cp $TEM/php.ini /etc/

# configure apache
chkconfig httpd on
mv /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.orig
cp $TEM/httpd.conf /etc/httpd/conf/
sed -i "s/\(^ServerAdmin \).*/\1${ADMIN}/" /etc/httpd/conf/httpd.conf
cp $TEM/vhost.conf /etc/httpd/conf.d/$DOMAIN.conf
sed -i "s/virtualdomain.com/${DOMAIN}/g" /etc/httpd/conf.d/$DOMAIN.conf

# configure postfix
chkconfig postfix on
QUERY1="CREATE DATABASE IF NOT EXISTS mail;"
QUERY2="GRANT ALL ON mail.* TO 'mail_admin'@'localhost' IDENTIFIED BY '$PASSWD';"
QUERY3="FLUSH PRIVILEGES;"
SQL="${QUERY1}${QUERY2}${QUERY3}"
echo "Logging in to mysql as root..."
mysql -u root -p -e "$SQL"
mysql -u root -p$PASSWD mail < $TEM/mail.isam.sql
mv /etc/postfix/main.cf /etc/postfix/main.cf.orig
cp $TEM/main.cf /etc/postfix/
mv /etc/postfix/master.cf /etc/postfix/master.cf.orig
cp $TEM/master.cf /etc/postfix/
cp $TEM/mysql_virtual_domains.cf /etc/postfix/
cp $TEM/mysql_virtual_forwardings.cf /etc/postfix/
cp $TEM/mysql_virtual_mailboxes.cf /etc/postfix/
cp $TEM/mysql_virtual_mailbox_limits.cf /etc/postfix/
cp $TEM/mysql_virtual_transports.cf /etc/postfix/
sed -i "s/\(^myhostname = \).*$/\1${HOSTNAME}.${DOMAIN}/" /etc/postfix/main.cf
sed -i "s/\(^mydomain = \).*$/\1${DOMAIN}/" /etc/postfix/main.cf
sed -i "s/\(^password = \).*$/\1${PASSWD}/" /etc/postfix/mysql_virtual_domains.cf
sed -i "s/\(^password = \).*$/\1${PASSWD}/" /etc/postfix/mysql_virtual_forwardings.cf
sed -i "s/\(^password = \).*$/\1${PASSWD}/" /etc/postfix/mysql_virtual_mailboxes.cf
sed -i "s/\(^password = \).*$/\1${PASSWD}/" /etc/postfix/mysql_virtual_mailbox_limits.cf
sed -i "s/\(^password = \).*$/\1${PASSWD}/" /etc/postfix/mysql_virtual_transports.cf

# configure dovecot
chkconfig dovecot on
sed -i 's/^#\(protocols = \).*$/\1imap/' /etc/dovecot/dovecot.conf
\cp $TEM/dovecot.conf /etc/dovecot/
\cp $TEM/10-auth.conf /etc/dovecot/conf.d/
\cp $TEM/10-mail.conf /etc/dovecot/conf.d/
\cp $TEM/10-master.conf /etc/dovecot/conf.d/
\cp $TEM/10-ssl.conf /etc/dovecot/conf.d/
\cp $TEM/20-imap.conf /etc/dovecot/conf.d/
\cp $TEM/20-pop3.conf /etc/dovecot/conf.d/
\cp $TEM/90-quota.conf /etc/dovecot/conf.d/
\cp $TEM/auth-sql.conf.ext /etc/dovecot/conf.d/
cp $TEM/dovecot-dict-sql.conf.ext /etc/dovecot/
cp $TEM/dovecot-sql.conf.ext /etc/dovecot/
sed -i "s/mail.example.com/${HOSTNAME}.${DOMAIN}/g" /etc/dovecot/conf.d/10-ssl.conf
sed -i "s/\(password=\)password/\1${PASSWD}/" /etc/dovecot/dovecot-dict-sql.conf.ext
sed -i "s/\(password=\)password/\1${PASSWD}/" /etc/dovecot/dovecot-sql.conf.ext

# generate cert and key
genkey --days 365 $HOSTNAME.$DOMAIN

# reboot the system
echo "Configuration is complete and the system needs to reboot."
echo "Press any key to continue..."
read -n 1
init 6
exit 0

# AFTER REBOOT TASK LIST
# setup mail users
# setup virtualhosts
# check hostname with hostname
# check ntp is running and synced with ntpstat
# check selinux is on with sestatus
# telnet and openssl to check mail server
# check logs for errors
